# デプロイ手順書

LINE記録係ボットおよびアンケート集計システムのデプロイ手順です。

## 前提条件
* Google アカウント
* LINE Developers アカウント（およびLINE公式アカウント）

## 1. スプレッドシートの準備
1. Google スプレッドシートを新規作成します。名前は適当で構いません（例: `LINEボットDB`）。
2. このスプレッドシートがデータベースとして機能します。シート（タブ）はスクリプトの初回実行時に自動生成されるため、手動で作成する必要はありません。

## 2. Google Apps Script (GAS) のセットアップ
1. 作成したスプレッドシートのメニューから `拡張機能` > `Apps Script` をクリックします。
2. エディタが開いたら、以下のファイルを `src` フォルダ内のコードに基づいて作成します。
    * **注:** ローカルの `.gs` ファイルは、GASエディタ上の `コード.gs` (または `Code.gs`) に内容をコピーしてください。

    | ローカルファイル | GASファイル名 (例) | 説明 |
    | --- | --- | --- |
    | `src/code.gs` | `コード.gs` | 全てのスクリプト（メインロジック、シート操作、LINE API、Webアプリ） |
    | `src/index.html`| `index.html` | 結果表示用HTML |

3. `src/code.gs` の内容を `コード.gs` に全て上書きコピーします。
4. `+` ボタンから `HTML` を選択し、ファイル名を `index` として作成します。
5. `src/index.html` の内容を `index.html` にコピーします。
6. プロジェクトを保存します。

## 3. LINE公式アカウントのセットアップ
1. [LINE Developers Console](https://developers.line.biz/) にログインします。
2. 新規プロバイダーを作成（または既存を選択）し、新規チャネル（Messaging API）を作成します。
3. **Messaging API設定** タブを開き、以下の操作を行います。
    * **チャネルアクセストークン（長期）** を発行し、コピーしておきます。
    * **Webhook設定** は後ほど設定します。
4. **応答メッセージ設定** (LINE Official Account Manager) で以下を設定します。
    * **応答メッセージ**: オフ
    * **あいさつメッセージ**: 必要に応じてオン/オフ（ボットの動作には影響しませんが、オフ推奨）
    * **Webhook**: オン

## 4. スクリプトプロパティの設定
GASエディタに戻り、環境変数を設定します。

1. 左側の設定アイコン（歯車）をクリックします。
2. **スクリプトプロパティ** の「スクリプトプロパティを追加」をクリックし、以下を追加します。

| プロパティ名 | 値 |
| --- | --- |
| `CHANNEL_ACCESS_TOKEN` | 手順3で発行したLINEチャネルアクセストークン |
| `SPREADSHEET_ID` | 作成したスプレッドシートのID (URLの `/d/` と `/edit` の間の文字列) |
| `WEB_APP_URL` | (空欄のまま一時保存) ※次の手順で取得して入力します |

## 5. デプロイとWebhookの設定
1. GASエディタ右上の **デプロイ** > **新しいデプロイ** をクリックします。
2. 「種類の選択」の歯車アイコンから **ウェブアプリ** を選択します。
3. 設定項目を入力します。
    * **説明**: `Initial Deploy` など
    * **次のユーザーとして実行**: `自分` (自分 = スプレッドシートの所有者)
    * **アクセスできるユーザー**: `全員` (LINEプラットフォームからのアクセスと、アンケート結果閲覧のため)
4. **デプロイ** をクリックします。
5. **ウェブアプリ URL** が発行されるのでコピーします。
6. **スクリプトプロパティ** に戻り、`WEB_APP_URL` にこのURLを設定して保存します。
7. LINE Developers Consoleに戻り、**Webhook URL** にこのURLを貼り付け、**更新** をクリックします。
8. **検証** ボタンを押して、成功することを確認します。

## 6. 動作確認
1. LINEボットを友だち追加します。
2. 適当なメッセージを送信し、既読になればOKです。
3. スプレッドシートの「投稿」シートにログが記録されているか確認します。
4. `[アンケート] 今日は元気ですか？` または `[Ankieta] Jak się masz?` と送信します。
5. OK/NGボタン付きのメッセージが返信されるか確認します。
    * メッセージ内に、アンケート本文の翻訳が含まれていることを確認してください。
6. ボタンを押し、その後のリンクから結果ページが表示されるか確認します。
